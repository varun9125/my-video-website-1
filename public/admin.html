<script>
let selectedThumbnail = null;

/* ===== GENERATE MULTIPLE THUMBNAILS (5 CLICKBAIT FRAMES) ===== */
function generateThumbs(file){
 const box = document.getElementById("thumbBox");
 const grid = document.getElementById("thumbGrid");
 grid.innerHTML="";
 box.style.display="block";

 const video = document.createElement("video");
 video.src = URL.createObjectURL(file);
 video.muted = true;
 video.playsInline = true;

 video.onloadedmetadata = () => {
   const d = video.duration;
   const times = [
     d * 0.15,
     d * 0.30,
     d * 0.45,
     d * 0.60,
     d * 0.75
   ];

   let i = 0;
   const next = () => {
     if(i >= times.length) return;
     captureFrame(video, times[i++], next);
   };
   next();
 };
}

function captureFrame(video, time, done){
 const canvas = document.createElement("canvas");
 const ctx = canvas.getContext("2d");

 video.currentTime = time;

 video.onseeked = () => {
   canvas.width = 320;
   canvas.height = 180;
   ctx.drawImage(video, 0, 0, 320, 180);

   const img = document.createElement("img");
   img.src = canvas.toDataURL("image/jpeg", 0.85);

   img.onclick = () => {
     document
       .querySelectorAll(".thumb-grid img")
       .forEach(i => i.classList.remove("selected"));
     img.classList.add("selected");
     selectedThumbnail = img.src;
   };

   document.getElementById("thumbGrid").appendChild(img);
   done();
 };
}

/* ===== UPLOAD WITH THUMBNAIL ===== */
function upload(){
 const btn = document.getElementById("btn");
 const status = document.getElementById("status");
 const bar = document.getElementById("bar");
 const progress = document.getElementById("progress");

 const password = passwordInput.value.trim();
 const title = titleInput.value.trim();
 const file = videoInput.files[0];

 if(!password){
  status.innerHTML="<span class='err'>❌ Admin password required</span>";
  return;
 }
 if(!file){
  status.innerHTML="<span class='err'>❌ Select a video</span>";
  return;
 }
 if(!selectedThumbnail){
  status.innerHTML="<span class='err'>❌ Select a thumbnail</span>";
  return;
 }

 btn.disabled = true;
 status.innerHTML = "⏳ Uploading… please wait";
 progress.style.display = "block";
 bar.style.width = "5%";

 const fd = new FormData();
 fd.append("password", password);
 fd.append("title", title || "Untitled");
 fd.append("video", file);
 fd.append("thumbnail", selectedThumbnail); // ✅ MAIN FIX

 const xhr = new XMLHttpRequest();
 xhr.open("POST", "/api/upload");

 xhr.upload.onprogress = e => {
  if(e.lengthComputable){
   bar.style.width = Math.round((e.loaded / e.total) * 90) + "%";
  }
 };

 xhr.onload = () => {
  bar.style.width = "100%";
  try{
   const res = JSON.parse(xhr.responseText || "{}");
   if(res.success){
    status.innerHTML = "<span class='ok'>✅ Upload successful</span>";
    videoInput.value = "";
    titleInput.value = "";
    selectedThumbnail = null;
    document.getElementById("thumbBox").style.display = "none";
   }else{
    status.innerHTML = "<span class='err'>❌ " + (res.error || "Failed") + "</span>";
   }
  }catch{
   status.innerHTML = "<span class='err'>❌ Server error</span>";
  }
  btn.disabled = false;
 };

 xhr.onerror = () => {
  status.innerHTML = "<span class='err'>❌ Network error</span>";
  btn.disabled = false;
 };

 xhr.send(fd);
}

/* shortcuts */
const passwordInput = document.getElementById("password");
const titleInput = document.getElementById("title");
const videoInput = document.getElementById("video");
</script>
