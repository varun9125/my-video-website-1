<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel | KamaBaba Viral</title>

<link rel="icon" href="/favicon.ico">
<meta name="robots" content="noindex,nofollow">

<style>
body{margin:0;background:#0b0b0b;color:#fff;font-family:system-ui}
.wrapper{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.panel{width:100%;max-width:460px;background:#141414;padding:24px;border-radius:16px;box-shadow:0 0 30px rgba(255,0,85,.25)}
h2{text-align:center;margin:0 0 10px;color:#ff0055}
label{display:block;margin-top:14px;font-size:13px;color:#bbb}
input{width:100%;padding:12px;margin-top:6px;border-radius:10px;border:1px solid #222;background:#0f0f0f;color:#fff}
button{width:100%;margin-top:18px;padding:14px;border:none;border-radius:12px;background:#ff0055;color:#fff;font-weight:600;cursor:pointer}
button:disabled{opacity:.6;cursor:not-allowed}
.thumb-box{display:none;margin-top:14px}
.thumb-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:6px}
.thumb-grid img{width:100%;border-radius:6px;cursor:pointer;border:2px solid transparent}
.thumb-grid img.selected{border-color:#ff0055}
.progress{display:none;height:8px;background:#222;margin-top:14px;border-radius:10px;overflow:hidden}
.progress div{height:100%;width:0%;background:#ff0055;transition:width .2s}
#status{margin-top:12px;font-size:14px;text-align:center;min-height:20px}
.ok{color:#0f9d58}
.err{color:#ff4444}
</style>
</head>

<body>
<div class="wrapper">
<div class="panel">

<h2>üîê Admin Upload</h2>

<label>Password</label>
<input id="password" type="password" placeholder="Admin password">

<label>Video Title</label>
<input id="title" type="text" placeholder="SEO friendly title">

<label>Select Video</label>
<input id="video" type="file" accept="video/*">

<div class="thumb-box" id="thumbBox">
 <p style="font-size:13px;color:#bbb">Select Thumbnail</p>
 <div class="thumb-grid" id="thumbGrid"></div>
</div>

<div class="progress" id="progress"><div id="bar"></div></div>

<button id="btn">üöÄ Upload</button>
<div id="status"></div>

</div>
</div>

<script>
/* ===== CLOUDINARY CONFIG ===== */
const CLOUD_NAME = "doeuirlh";
const UPLOAD_PRESET = "kamababa_unsigned";
const CHUNK_SIZE = 10 * 1024 * 1024; // üî• 10MB chunks

let selectedThumbnail=null;
const passwordInput=document.getElementById("password");
const titleInput=document.getElementById("title");
const videoInput=document.getElementById("video");
const thumbBox=document.getElementById("thumbBox");
const thumbGrid=document.getElementById("thumbGrid");
const btn=document.getElementById("btn");
const status=document.getElementById("status");
const bar=document.getElementById("bar");
const progress=document.getElementById("progress");

/* ===== THUMBNAIL (UNCHANGED) ===== */
videoInput.addEventListener("change",()=>{
 const file=videoInput.files[0];
 if(!file||!file.type.startsWith("video/")) return;

 thumbGrid.innerHTML="";
 thumbBox.style.display="block";
 selectedThumbnail=null;

 const video=document.createElement("video");
 video.src=URL.createObjectURL(file);
 video.muted=true;

 video.onloadedmetadata=async()=>{
  const d=video.duration;
  for(const t of [0.2,0.4,0.6,0.8]){
   const img=await capture(video,d*t);
   thumbGrid.appendChild(img);
  }
 };
});

function capture(video,time){
 return new Promise(resolve=>{
  const c=document.createElement("canvas");
  const x=c.getContext("2d");
  video.currentTime=time;
  video.onseeked=()=>{
   c.width=320;c.height=180;
   x.drawImage(video,0,0,320,180);
   const img=document.createElement("img");
   img.src=c.toDataURL("image/jpeg",0.9);
   img.onclick=()=>{
    document.querySelectorAll("#thumbGrid img").forEach(i=>i.classList.remove("selected"));
    img.classList.add("selected");
    selectedThumbnail=img.src;
   };
   resolve(img);
  };
 });
}

/* ===== FAST CHUNKED UPLOAD ===== */
btn.onclick=async()=>{
 if(!passwordInput.value||!videoInput.files[0]||!selectedThumbnail){
  status.innerHTML="<span class='err'>‚ùå Missing data</span>";return;
 }

 btn.disabled=true;
 progress.style.display="block";
 status.innerText="Uploading in chunks‚Ä¶";

 const file=videoInput.files[0];
 let uploaded=0;

 while(uploaded < file.size){
  const chunk=file.slice(uploaded, uploaded + CHUNK_SIZE);
  const fd=new FormData();
  fd.append("file", chunk);
  fd.append("upload_preset", UPLOAD_PRESET);
  fd.append("folder", "kamababa/videos");
  fd.append("chunk_size", CHUNK_SIZE);

  const res=await fetch(
   `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/video/upload`,
   { method:"POST", body:fd }
  );

  const data=await res.json();
  if(!data.secure_url){
   status.innerHTML="<span class='err'>‚ùå Upload failed</span>";
   btn.disabled=false;return;
  }

  uploaded += CHUNK_SIZE;
  bar.style.width=Math.min(80, Math.round((uploaded/file.size)*80))+"%";

  if(uploaded >= file.size){
   bar.style.width="90%";
   status.innerText="Saving to server‚Ä¶";

   const save=await fetch("/api/save-video",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
     password:passwordInput.value,
     title:titleInput.value||"Untitled",
     url:data.secure_url
    })
   });

   const out=await save.json();
   if(out.success){
    bar.style.width="100%";
    status.innerHTML="<span class='ok'>‚úÖ Upload successful</span>";
    videoInput.value="";titleInput.value="";thumbBox.style.display="none";
   }else{
    status.innerHTML="<span class='err'>‚ùå Save failed</span>";
   }
   btn.disabled=false;
   break;
  }
 }
};
</script>

</body>
</html>
