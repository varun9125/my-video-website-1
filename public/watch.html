<script>
/* AGE GATE */
if(localStorage.adult==="yes") ageGate.style.display="none";
function allow(){localStorage.adult="yes";ageGate.style.display="none"}
function deny(){location.href="https://google.com"}

const id=new URLSearchParams(location.search).get("id");
const titleEl=document.getElementById("title");
const viewCount=document.getElementById("viewCount");
const likeCount=document.getElementById("likeCount");
const related=document.getElementById("related");
const loader=document.getElementById("loader");

let allVideos=[];
let player=videojs("player");

/* AUTO THUMB (fallback) */
function autoThumb(url){
 if(!url || !url.includes("/video/upload/")) return "/logo.png";
 return url
  .replace("/video/upload/","/video/upload/so_1/")
  .replace(/\.(mp4|webm|mov).*/i,".jpg");
}

/* LOAD DATA */
fetch("/api/videos")
.then(r=>r.json())
.then(vs=>{
 allVideos = Array.isArray(vs) ? vs : [];
 const v = allVideos.find(x=>x._id===id);

 if(!v){
  titleEl.innerText="Video not found";
  loader.style.display="none";
  return;
 }

 titleEl.innerText=v.title;
 viewCount.innerText=v.views||0;
 likeCount.innerText=v.likes||0;

 player.src({src:v.url,type:"video/mp4"});

 try{
  player.ima({
   adTagUrl:"https://s.magsrv.com/v1/vast.php?idzone=5809070",
   timeout:8000
  });
  player.one("play",()=>{
   try{
    player.ima.initializeAdDisplayContainer();
    player.ima.requestAds();
   }catch(e){}
  });
 }catch(e){}

 if(!sessionStorage["v_"+id]){
  fetch("/api/view/"+id,{method:"POST"});
  viewCount.innerText++;
  sessionStorage["v_"+id]=1;
 }

 renderRelated();
})
.catch(()=>{ loader.style.display="none"; });

/* ✅ RELATED — IMAGE THUMB ONLY (FIXED) */
function renderRelated(){
 loader.style.display="none";
 related.innerHTML="";
 if(!allVideos.length) return;

 allVideos
 .filter(v=>v._id!==id)
 .slice(0,8)
 .forEach(v=>{
  const thumb = v.thumbnail || autoThumb(v.url);
  const c=document.createElement("div");
  c.className="card";
  c.innerHTML=`
   <img src="${thumb}" style="width:100%;aspect-ratio:16/9;object-fit:cover">
   <p>${v.title}</p>`;
  c.onclick=()=>location.href="/watch?id="+v._id;
  related.appendChild(c);
 });
}

function like(){
 if(sessionStorage["l_"+id])return;
 fetch("/api/like/"+id,{method:"POST"});
 likeCount.innerText++;
 sessionStorage["l_"+id]=1;
}

function share(){
 navigator.clipboard.writeText(location.href);
 alert("Link copied");
}

/* SMARTLINK */
let opened=false;
document.addEventListener("click",()=>{
 if(!opened){
  window.open("https://www.effectivegatecpm.com/t08q3aadri?key=17e7075568b797a5f86e95c5711c322a","_blank");
  opened=true;
 }
},{once:true});
</script>
