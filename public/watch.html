<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Watch Video | KamaBaba Viral</title>

<link rel="icon" href="/favicon.ico">
<meta name="theme-color" content="#000000">

<style>
body{margin:0;background:#000;color:#fff;font-family:system-ui}
.top{padding:10px;text-align:center;border-bottom:1px solid #222}
.top img{height:36px}

.adbox{padding:12px;text-align:center}

.playerWrap{width:100%;max-width:900px;margin:0 auto;background:#000}
video{width:100%;height:auto;max-height:70vh;background:#000}

.info{padding:12px;max-width:900px;margin:auto}
h1{font-size:18px;margin:0 0 6px}
.meta{font-size:13px;color:#aaa}
.actions{display:flex;gap:10px;margin-top:10px}
.actions button{
 padding:8px 14px;
 border:none;
 border-radius:8px;
 background:#1c1c1c;
 color:#fff;
 cursor:pointer
}

.related-title{padding:12px;max-width:900px;margin:auto}
.grid{
 display:grid;
 grid-template-columns:repeat(auto-fill,minmax(160px,1fr));
 gap:12px;
 padding:12px;
 max-width:900px;
 margin:auto
}
.card{background:#111;border-radius:8px;overflow:hidden;cursor:pointer}
.card img{width:100%;aspect-ratio:16/9;object-fit:cover}
.card p{font-size:13px;margin:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

#msg{padding:20px;text-align:center;color:#888}
</style>
</head>

<body>

<div class="top">
 <img src="/logo.png" alt="KamaBaba Viral">
</div>

<!-- üî• TOP AD -->
<div class="adbox">
<script async data-cfasync="false"
 src="https://pl28304315.effectivegatecpm.com/75174a0c15fdc41fe820fb9dadf17605/invoke.js"></script>
<div id="container-75174a0c15fdc41fe820fb9dadf17605"></div>
</div>

<div class="playerWrap">
 <video id="player" controls playsinline preload="metadata"></video>
</div>

<div class="info">
 <h1 id="title">Loading‚Ä¶</h1>
 <div class="meta">
  üëÅ <span id="views">0</span> ¬∑ üëç <span id="likes">0</span>
 </div>

 <div class="actions">
  <button onclick="like()">üëç Like</button>
  <button onclick="share()">üîó Share</button>
 </div>
</div>

<!-- üî• MID AD -->
<div class="adbox">
<script async data-cfasync="false"
 src="https://pl28304315.effectivegatecpm.com/75174a0c15fdc41fe820fb9dadf17605/invoke.js"></script>
<div id="container-75174a0c15fdc41fe820fb9dadf17605"></div>
</div>

<div class="related-title">
 <h3>Related Videos</h3>
</div>

<div id="msg">Loading‚Ä¶</div>
<div class="grid" id="related"></div>

<script>
const id = new URLSearchParams(location.search).get("id");
const player = document.getElementById("player");
const titleEl = document.getElementById("title");
const viewsEl = document.getElementById("views");
const likesEl = document.getElementById("likes");
const related = document.getElementById("related");
const msg = document.getElementById("msg");

let allVideos = [];
let current = null;

/* LOAD VIDEOS */
fetch("/api/videos")
.then(r=>r.json())
.then(list=>{
 allVideos = Array.isArray(list) ? list : [];
 current = allVideos.find(v=>v._id === id);

 if(!current){
  titleEl.innerText = "Video not found";
  msg.innerText = "This video does not exist.";
  return;
 }

 titleEl.innerText = current.title || "Untitled";
 viewsEl.innerText = current.views || 0;
 likesEl.innerText = current.likes || 0;

 player.src = current.url;
 player.load();

 if(!sessionStorage["v_"+id]){
  fetch("/api/view/"+id,{method:"POST"});
  viewsEl.innerText = Number(viewsEl.innerText)+1;
  sessionStorage["v_"+id]=1;
 }

 renderRelated();
 msg.style.display="none";
})
.catch(()=>{
 msg.innerText="Failed to load video.";
});

/* RELATED */
function renderRelated(){
 related.innerHTML="";
 allVideos
 .filter(v=>v._id!==id)
 .slice(0,12)
 .forEach(v=>{
  const d=document.createElement("div");
  d.className="card";
  d.onclick=()=>location.href="/watch.html?id="+v._id;

  const thumb=v.thumbnail||
   "https://via.placeholder.com/320x180/111/666?text=Video";

  d.innerHTML=`
   <img src="${thumb}" loading="lazy">
   <p>${v.title||"Untitled"}</p>
  `;
  related.appendChild(d);
 });
}

/* LIKE */
function like(){
 if(sessionStorage["l_"+id]) return;
 fetch("/api/like/"+id,{method:"POST"});
 likesEl.innerText = Number(likesEl.innerText)+1;
 sessionStorage["l_"+id]=1;
}

/* SHARE */
function share(){
 navigator.clipboard.writeText(location.href);
 alert("Link copied");
}

/* üî• SMARTLINK (FIRST CLICK ONLY) */
let opened=false;
document.addEventListener("click",()=>{
 if(!opened){
  window.open(
   "https://www.effectivegatecpm.com/t08q3aadri?key=17e7075568b797a5f86e95c5711c322a",
   "_blank"
  );
  opened=true;
 }
},{once:true});
</script>

</body>
</html>
